from prometheus_client import CollectorRegistry, Gauge, push_to_gateway
import pandas as pd

# === CONFIG ===
csv_file = "data.csv"
pushgateway_url = "http://localhost:9091"  # change this to your Pushgateway
job_name = "csv_data_push"

# === READ CSV ===
df = pd.read_csv(csv_file)

registry = CollectorRegistry()
gauges = {}  # store one Gauge per numeric column

for col in df.columns:
    if pd.api.types.is_numeric_dtype(df[col]):
        gauges[col] = Gauge(
            "csv_" + col.lower().replace(" ", "_"),
            f"Metric for column {col}",
            labelnames=[c.lower().replace(" ", "_") for c in df.columns if not pd.api.types.is_numeric_dtype(df[c])] + ["all_data"],
            registry=registry
        )

# === PUSH ALL ROWS ===
for _, row in df.iterrows():
    labels = {}
    all_data = ",".join(str(x) for x in row.values)
    for c in df.columns:
        if not pd.api.types.is_numeric_dtype(df[c]):
            labels[c.lower().replace(" ", "_")] = str(row[c])
    labels["all_data"] = all_data

    for col in df.columns:
        if pd.api.types.is_numeric_dtype(df[col]):
            g = gauges[col]
            g.labels(**labels).set(float(row[col]))

# === PUSH TO GATEWAY ===
push_to_gateway(pushgateway_url, job=job_name, registry=registry)
print("âœ… All rows pushed to Pushgateway successfully!")