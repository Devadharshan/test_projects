import os
import pandas as pd
import oracledb
import logging
from datetime import datetime

# ========= Logging Setup =========
log_filename = f"oracle_execution_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log"
logging.basicConfig(
    filename=log_filename,
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# ========= Step 1: Folder with files =========
folder_path = "codes_files"

# List all .xls files
xls_files = [f for f in os.listdir(folder_path) if f.endswith(".xls")]

if not xls_files:
    logging.warning("‚ö†Ô∏è No .xls files found in codes_files folder. Exiting.")
    exit()

# ========= Step 2: Oracle DB Connection =========
try:
    oracledb.init_oracle_client(lib_dir=r"C:\path\to\instant_client")
    conn = oracledb.connect(
        user="your_username",
        password="your_password",
        dsn="hostname:port/service_name"
    )
    cursor = conn.cursor()
    logging.info("‚úÖ Oracle DB connection established.")
except Exception as e:
    logging.error(f"‚ùå Failed to connect to Oracle DB: {e}")
    exit()

# ========= Step 3: Queries =========
queries = [
    "SELECT * FROM codes_table WHERE code IN ({codes})",
    "SELECT COUNT(*) FROM employees WHERE code IN ({codes})",
    "SELECT code, status FROM orders WHERE code IN ({codes})",
    "SELECT DISTINCT region FROM customers WHERE code IN ({codes})",
    "SELECT code, SUM(amount) FROM transactions WHERE code IN ({codes}) GROUP BY code"
]

# ========= Step 4: Process each file =========
sql_output_file = f"executed_queries_{datetime.now().strftime('%Y%m%d_%H%M%S')}.sql"

with open(sql_output_file, "w") as f:
    for file_name in xls_files:
        file_path = os.path.join(folder_path, file_name)
        logging.info(f"üìÇ Processing file: {file_name}")

        try:
            # Read HTML disguised as Excel
            df_list = pd.read_html(file_path)
            df = df_list[0]

            # Extract all "Codes" columns
            code_columns = [col for col in df.columns if "Codes" in str(col)]
            codes = set()
            for col in code_columns:
                codes.update(df[col].dropna().astype(str).tolist())
            codes = list(codes)

            if not codes:
                logging.warning(f"‚ö†Ô∏è No codes found in file {file_name}. Skipping.")
                continue

            # Prepare codes for IN clause
            codes_list = ",".join([f"'{c}'" for c in codes])

            # Execute queries
            for idx, q in enumerate(queries, start=1):
                try:
                    actual_sql = q.replace("{codes}", codes_list)
                    f.write(f"-- From file: {file_name}\n{actual_sql};\n\n")

                    # Use bind variables for safety
                    placeholders = ",".join([f":c{i}" for i in range(len(codes))])
                    sql_with_placeholders = q.replace("{codes}", placeholders)
                    bind_vars = {f"c{i}": code for i, code in enumerate(codes)}

                    cursor.execute(sql_with_placeholders, bind_vars)
                    result = cursor.fetchall()

                    # Log summary
                    row_count = len(result)
                    if row_count > 0:
                        logging.info(f"{file_name} | Query {idx}: ‚úÖ Data found ({row_count} rows)")
                    else:
                        logging.info(f"{file_name} | Query {idx}: ‚ö†Ô∏è No data found")

                except Exception as qe:
                    logging.error(f"{file_name} | Query {idx}: ‚ùå Failed - {qe}")

        except Exception as fe:
            logging.error(f"‚ùå Failed to process file {file_name}: {fe}")

# ========= Step 5: Close Connection =========
cursor.close()
conn.close()
logging.info("‚úÖ Connection closed. All queries executed.")