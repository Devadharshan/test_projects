import os
import time
import subprocess

WATCH_FOLDER = r"\\NAS-SERVER\sharepath"
processed_files = set()

def send_email_via_powershell(csv_path):
    ps_script = f'''
    $EmailFrom = "noreply@example.com"
    $EmailTo = "receiver@example.com"
    $Subject = "New CSV File Received: {os.path.basename(csv_path)}"
    $Body = "A new CSV file has been placed at {csv_path}"
    $SMTPServer = "your.mail.server.com"
    Send-MailMessage -From $EmailFrom -To $EmailTo -Subject $Subject -Body $Body -Attachments "{csv_path}" -SmtpServer $SMTPServer
    '''
    subprocess.run(["powershell", "-Command", ps_script], check=True)
    print(f"ðŸ“§ Email sent using PowerShell: {csv_path}")

def watch_folder():
    print(f"ðŸ‘€ Watching for new CSV files in: {WATCH_FOLDER}")
    while True:
        for file_name in os.listdir(WATCH_FOLDER):
            if file_name.lower().endswith(".csv"):
                full_path = os.path.join(WATCH_FOLDER, file_name)
                if full_path not in processed_files:
                    send_email_via_powershell(full_path)
                    processed_files.add(full_path)
        time.sleep(10)

if __name__ == "__main__":
    watch_folder()