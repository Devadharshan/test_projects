import os
import pandas as pd
from prometheus_client import CollectorRegistry, Gauge, push_to_gateway

# ==== CONFIG ====
CSV_DIR = "bp_data_folder"  # folder containing multiple CSVs
PUSHGATEWAY = "http://localhost:9091"
JOB_NAME = "bp_trade_metrics"

# ==== READ & MERGE ALL CSV FILES ====
dataframes = []
for file in os.listdir(CSV_DIR):
    if file.endswith(".csv"):
        full_path = os.path.join(CSV_DIR, file)
        print(f"Reading: {full_path}")
        df = pd.read_csv(full_path)
        dataframes.append(df)

if not dataframes:
    raise ValueError(f"No CSV files found in directory: {CSV_DIR}")

df = pd.concat(dataframes, ignore_index=True)
print(f"✅ Loaded {len(df)} rows from {len(dataframes)} files")

# ==== ENSURE REQUIRED COLUMNS ====
required_cols = ['bp_name', 'job_details', 'duration']
missing = [col for col in required_cols if col not in df.columns]
if missing:
    raise ValueError(f"Missing required columns in CSV: {missing}")

# ==== CREATE REGISTRY ====
registry = CollectorRegistry()

# ==== DEFINE GAUGES ====
gauge_trade_duration = Gauge(
    'bp_trade_duration_seconds',
    'Duration of each trade per BP',
    ['bp_name', 'job_details'],
    registry=registry
)

gauge_avg_bp = Gauge(
    'bp_avg_duration_per_trade',
    'Average duration per BP',
    ['bp_name'],
    registry=registry
)

gauge_avg_bp_job = Gauge(
    'bp_avg_duration_per_trade_job',
    'Average duration per BP and Job',
    ['bp_name', 'job_details'],
    registry=registry
)

# (Optional but useful)
gauge_trade_count = Gauge(
    'bp_trade_count',
    'Number of trades processed per BP',
    ['bp_name'],
    registry=registry
)

# ==== POPULATE METRICS ====

# 1️⃣ Each trade duration
for _, row in df.iterrows():
    gauge_trade_duration.labels(
        bp_name=row['bp_name'],
        job_details=row['job_details']
    ).set(row['duration'])

# 2️⃣ Average per BP
avg_bp = df.groupby('bp_name')['duration'].mean().reset_index()
for _, row in avg_bp.iterrows():
    gauge_avg_bp.labels(bp_name=row['bp_name']).set(row['duration'])

# 3️⃣ Average per BP + Job
avg_bp_job = df.groupby(['bp_name', 'job_details'])['duration'].mean().reset_index()
for _, row in avg_bp_job.iterrows():
    gauge_avg_bp_job.labels(
        bp_name=row['bp_name'],
        job_details=row['job_details']
    ).set(row['duration'])

# 4️⃣ Count per BP
count_bp = df.groupby('bp_name')['duration'].count().reset_index(name='trade_count')
for _, row in count_bp.iterrows():
    gauge_trade_count.labels(bp_name=row['bp_name']).set(row['trade_count'])

# ==== PUSH TO GATEWAY ====
push_to_gateway(PUSHGATEWAY, job=JOB_NAME, registry=registry)
print(f"✅ Metrics pushed successfully to {PUSHGATEWAY} under job '{JOB_NAME}'")