import os
import pandas as pd
from prometheus_client import CollectorRegistry, Gauge, push_to_gateway
import re

# ---------------- CONFIG ----------------
CSV_FOLDER = r"<PATH_TO_CSV_FOLDER>"     # Example: r"D:\bp_data"
PUSHGATEWAY = "<PUSHGATEWAY_URL>"        # Example: "http://localhost:9091"
JOB_NAME = "bp_raw_job_runs"
# ----------------------------------------


def sanitize_label(value):
    if pd.isna(value):
        return ""
    return str(value).replace(" ", "_").replace(",", "_")


def extract_date_from_filename(filename):
    match = re.search(r"(\d{4}-\d{2}-\d{2})", filename)
    return match.group(1) if match else "unknown"


def process_files():
    registry = CollectorRegistry()

    metric = Gauge(
        "bp_job_run_info",
        "Business process job run info",
        [
            "bp_name","thread_id","job_id","start_time","end_time",
            "no_of_trades","duration_per_trade","job_details","file_date"
        ],
        registry=registry
    )

    for file in os.listdir(CSV_FOLDER):
        if not file.endswith(".csv"):
            continue
        if "_summary" in file:
            continue  # ignore summary in this script

        file_path = os.path.join(CSV_FOLDER, file)
        file_date = extract_date_from_filename(file)

        try:
            df = pd.read_csv(file_path)
        except Exception as e:
            print(f"Error reading {file}: {e}")
            continue

        required_columns = [
            "BP Name","Thread ID","JOB ID","Start Time","End Time",
            "Duration","No of trades","DurationPerTrade","JobDetails"
        ]

        if not all(col in df.columns for col in required_columns):
            print(f"Skipping {file} - missing columns")
            continue

        df = df[required_columns]

        for _, row in df.iterrows():
            metric.labels(
                bp_name=sanitize_label(row["BP Name"]),
                thread_id=sanitize_label(row["Thread ID"]),
                job_id=sanitize_label(row["JOB ID"]),
                start_time=sanitize_label(row["Start Time"]),
                end_time=sanitize_label(row["End Time"]),
                no_of_trades=sanitize_label(row["No of trades"]),
                duration_per_trade=sanitize_label(row["DurationPerTrade"]),
                job_details=sanitize_label(row["JobDetails"]),
                file_date=file_date
            ).set(float(row["Duration"]))

    push_to_gateway(PUSHGATEWAY, job=JOB_NAME, registry=registry)
    print("âœ… Successfully pushed all raw job run metrics from all CSV files.")


if __name__ == "__main__":
    process_files()