import os
import json
import time
import logging
from datetime import datetime
import shutil

# Create log file name with timestamp
timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
log_file = f"cleanup_folders_{timestamp}.log"

logging.basicConfig(
    filename=log_file,
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

def load_config(config_file):
    with open(config_file, 'r') as f:
        return json.load(f)

def format_size(bytes_value):
    for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
        if bytes_value < 1024:
            return f"{bytes_value:.2f} {unit}"
        bytes_value /= 1024

def delete_old_items(base_path, retention_days):
    now = time.time()
    cutoff_time = now - (retention_days * 86400)

    # Disk usage before cleanup
    total_before, used_before, free_before = shutil.disk_usage(base_path)

    logging.info(f"Starting cleanup in: {base_path}, Retention: {retention_days} days")
    logging.info(f"Disk before cleanup: Total={format_size(total_before)}, Free={format_size(free_before)}")

    if not os.path.exists(base_path):
        logging.error(f"Path does not exist: {base_path}")
        return

    deleted_bytes = 0

    for root, dirs, files in os.walk(base_path, topdown=False):

        # Delete files
        for file_name in files:
            file_path = os.path.join(root, file_name)
            try:
                if os.path.getmtime(file_path) < cutoff_time:
                    size = os.path.getsize(file_path)
                    os.remove(file_path)
                    deleted_bytes += size
                    logging.info(f"Deleted file: {file_path} ({format_size(size)})")
            except Exception as e:
                logging.error(f"Error deleting file {file_path}: {e}")

        # Delete folders
        for dir_name in dirs:
            dir_path = os.path.join(root, dir_name)
            try:
                if os.path.getmtime(dir_path) < cutoff_time:
                    folder_size = 0
                    for path, _, files_in_folder in os.walk(dir_path):
                        for f in files_in_folder:
                            fp = os.path.join(path, f)
                            if os.path.exists(fp):
                                folder_size += os.path.getsize(fp)

                    shutil.rmtree(dir_path, ignore_errors=True)
                    deleted_bytes += folder_size
                    logging.info(f"Deleted folder: {dir_path} (Recovered approx: {format_size(folder_size)})")
            except Exception as e:
                logging.error(f"Error deleting folder {dir_path}: {e}")

    # Disk usage after
    total_after, used_after, free_after = shutil.disk_usage(base_path)

    reclaimed = free_after - free_before

    logging.info("Cleanup Completed")
    logging.info(f"Disk after cleanup: Total={format_size(total_after)}, Free={format_size(free_after)}")
    logging.info(f"Total Space Reclaimed: {format_size(reclaimed)}")
    logging.info(f"Total Data Deleted (Measured): {format_size(deleted_bytes)}")

if __name__ == "__main__":
    config = load_config("config.json")
    base_path = config.get("base_path")
    retention_days = int(config.get("retention_days", 30))
    delete_old_items(base_path, retention_days)