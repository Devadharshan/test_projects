#!/usr/bin/env python3
"""
push_bp_trend_raw.py (final)

- Trend-only (numeric) gauges.
- Computes time_taken and durationpertrade for non-summary.
- Raw table gauge for all CSV columns including Start/End Time.
- Sends metrics to Pushgateway.
- Windows labels: today, yesterday, last_7_days, last_30_days (based on file_date).
Requires: pip install pandas prometheus_client
"""
import os, re
import pandas as pd
from datetime import datetime, timedelta, timezone
from prometheus_client import CollectorRegistry, Gauge, push_to_gateway

# ---------------- TIMEZONE ----------------
try:
    from zoneinfo import ZoneInfo
    IST = ZoneInfo("Asia/Kolkata")
except:
    IST = timezone(timedelta(hours=5,30))

# ---------------- CONFIG ----------------
DATA_FOLDER = r"C:\bpmetrics\data"  # Change as needed
PUSHGATEWAY = "http://localhost:9091"

JOB_SUMMARY_RAW = "bp_summary_raw"
JOB_NON_SUMMARY_RAW = "bp_non_summary_raw"

# ---------------- HELPERS ----------------
def read_csv_safely(path):
    try:
        return pd.read_csv(path, dtype=str)
    except UnicodeDecodeError:
        return pd.read_csv(path, encoding="latin-1", dtype=str)
    except:
        return pd.DataFrame()

def extract_date_from_filename(fname):
    m = re.findall(r"(\d{4}-\d{2}-\d{2})", fname)
    if not m:
        return None
    try:
        return datetime.strptime(m[-1], "%Y-%m-%d").date()
    except:
        return None

def clean_label_key(k: str) -> str:
    if k is None:
        return "unknown"
    s = str(k).strip().lower()
    s = re.sub(r'[^a-z0-9_]', '_', s)
    if not re.match(r'^[a-z]', s):
        s = 'k_' + s
    return s

def clean_label_value(v: str) -> str:
    if v is None:
        return "unknown"
    s = str(v).strip()
    if s == "":
        return "unknown"
    return re.sub(r'[^A-Za-z0-9_:./@-]', '_', s)

def is_number_like(s):
    if s is None:
        return False
    s = str(s).strip()
    if s == "":
        return False
    try:
        float(s.replace(",", ""))
        return True
    except:
        return False

def to_float(s):
    if s is None:
        return None
    s = str(s).strip()
    if s.lower() in ("", "nan"):
        return None
    try:
        return float(s.replace(",", ""))
    except:
        return None

def windows_for_date(d, today_date):
    """Return list of windows this date belongs to."""
    if d is None:
        return []
    windows = []
    yesterday = today_date - timedelta(days=1)
    if d == today_date:
        windows.append("today")
    if d == yesterday:
        windows.append("yesterday")
    if (today_date - timedelta(days=6)) <= d <= today_date:
        windows.append("last_7_days")
    if (today_date - timedelta(days=29)) <= d <= today_date:
        windows.append("last_30_days")
    return windows

# ---------------- MAIN ----------------
def main():
    today = datetime.now(IST).date()
    files = sorted([f for f in os.listdir(DATA_FOLDER) if f.lower().endswith(".csv")])

    if not files:
        print(f"No CSV files in {DATA_FOLDER}")
        return

    summary_rows, non_summary_rows = [], []

    for fname in files:
        full = os.path.join(DATA_FOLDER, fname)
        df = read_csv_safely(full)
        if df.empty:
            continue
        # preserve original columns
        df.columns = [c.strip() for c in df.columns]
        df["file_name"] = fname
        df["file_date"] = extract_date_from_filename(fname)
        if "_summary" in fname.lower():
            summary_rows.append(df)
        else:
            non_summary_rows.append(df)

    summary_df = pd.concat(summary_rows, ignore_index=True) if summary_rows else pd.DataFrame()
    ns_df = pd.concat(non_summary_rows, ignore_index=True) if non_summary_rows else pd.DataFrame()

    # ---------------- Non-summary time_taken & durationpertrade ----------------
    if not ns_df.empty:
        # find exact column names
        start_col = next((c for c in ns_df.columns if "start" in c.lower()), None)
        end_col = next((c for c in ns_df.columns if "end" in c.lower()), None)
        trades_col = next((c for c in ns_df.columns if "trade" in c.lower()), None)

        if start_col and end_col:
            s = pd.to_datetime(ns_df[start_col], dayfirst=True, errors="coerce")
            e = pd.to_datetime(ns_df[end_col], dayfirst=True, errors="coerce")
            ns_df["time_taken"] = (e - s).dt.total_seconds()
            ns_df["time_taken"] = ns_df["time_taken"].where(ns_df["time_taken"].notna(), None)
        else:
            ns_df["time_taken"] = None

        ns_df["duration"] = ns_df["time_taken"]

        if trades_col:
            ns_df["_trades_num"] = ns_df[trades_col].apply(to_float)
        else:
            ns_df["_trades_num"] = None

        def compute_dpt(row):
            dur = to_float(row.get("duration"))
            tr = to_float(row.get("_trades_num"))
            if dur is None or tr is None or tr == 0:
                return None
            return dur / tr

        ns_df["durationpertrade"] = ns_df.apply(compute_dpt, axis=1)
        ns_df.drop(columns=["_trades_num"], inplace=True)

    # ---------------- GAUGE HELPERS ----------------
    def prepare_gauges(df, prefix):
        gauges = {}
        if df.empty:
            return gauges
        numeric_cols = []
        for col in df.columns:
            if col in ("file_name","file_date"):
                continue
            if is_number_like(df[col].dropna().astype(str).head(50).tolist()[0]):
                numeric_cols.append(col)
        all_label_cols = [c for c in df.columns if c not in numeric_cols+["file_name","file_date"]]
        label_keys = [clean_label_key(c) for c in all_label_cols]+["file_name","file_date","window"]
        for col in numeric_cols:
            metric_name = prefix+"_"+re.sub(r'[^a-z0-9_]', '_', col.lower())
            if "duration" in col.lower() and not metric_name.endswith("_seconds"):
                metric_name += "_seconds"
            gauges[col] = (Gauge(metric_name, metric_name, labelnames=label_keys, registry=CollectorRegistry()), metric_name, label_keys)
        return gauges

    # ---------------- PUSH ROWS ----------------
    def push_rows(df, gauges_map, job_name):
        if df.empty or not gauges_map:
            return
        registry = CollectorRegistry()
        for col, (gauge, _, _) in gauges_map.items():
            gauge._registry = registry
        for _, row in df.iterrows():
            windows = windows_for_date(row.get("file_date"), today)
            if not windows:
                continue
            numeric_cols = gauges_map.keys()
            label_items = {clean_label_key(c): clean_label_value(row.get(c)) for c in df.columns if c not in numeric_cols+["file_date"]}
            for w in windows:
                label_items["file_name"] = clean_label_value(row.get("file_name",""))
                label_items["file_date"] = str(row.get("file_date",""))
                label_items["window"] = w
                for col, (gauge_obj, _, label_keys) in gauges_map.items():
                    val = to_float(row.get(col))
                    label_values = [label_items.get(lk,"unknown") for lk in label_keys]
                    try:
                        gauge_obj.labels(*label_values).set(val if val is not None else 0.0)
                    except:
                        continue
        push_to_gateway(PUSHGATEWAY, job=job_name, registry=registry)

    # ---------------- PUSH RAW TABLE ----------------
    def push_raw_table(df, job_name):
        if df.empty:
            return
        registry = CollectorRegistry()
        label_keys = [clean_label_key(c) for c in df.columns if c != "file_date"] + ["file_name","file_date","window"]
        g = Gauge("new_data_raw_table", "All CSV columns as labels", labelnames=label_keys, registry=registry)
        for _, row in df.iterrows():
            windows = windows_for_date(row.get("file_date"), today)
            for w in windows:
                label_values=[]
                for lk in label_keys:
                    if lk=="window":
                        label_values.append(w)
                    elif lk=="file_date":
                        label_values.append(str(row.get("file_date","")))
                    elif lk=="file_name":
                        label_values.append(str(row.get("file_name","")))
                    else:
                        label_values.append(str(row.get(lk,"")))
                g.labels(*label_values).set(1)
        push_to_gateway(PUSHGATEWAY, job=job_name, registry=registry)

    # ---------------- EXECUTE PUSH ----------------
    # Summary numeric
    summary_gauges = prepare_gauges(summary_df, "new_data_summary_row")
    push_rows(summary_df, summary_gauges, JOB_SUMMARY_RAW)
    push_raw_table(summary_df, JOB_SUMMARY_RAW+"_table")

    # Non-summary numeric
    ns_gauges = prepare_gauges(ns_df, "new_data_non_summary_row")
    push_rows(ns_df, ns_gauges, JOB_NON_SUMMARY_RAW)
    push_raw_table(ns_df, JOB_NON_SUMMARY_RAW+"_table")

    print("Done. Check Pushgateway:", PUSHGATEWAY)

if __name__=="__main__":
    main()