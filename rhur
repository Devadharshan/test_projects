import os
import json
import logging
from datetime import datetime, timedelta
import shutil
import ctypes

# ----- Load Config -----
with open("config.json", "r") as f:
    config = json.load(f)

BASE_PATH = config["share_path"]
RETENTION_DAYS = config["retention_days"]

# ----- Logging with Timestamp -----
log_filename = f"cleanup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log"
logging.basicConfig(
    filename=log_filename,
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

def get_total_free_space(path):
    free_bytes = ctypes.c_ulonglong(0)
    total_bytes = ctypes.c_ulonglong(0)
    ctypes.windll.kernel32.GetDiskFreeSpaceExW(
        ctypes.c_wchar_p(path), None, ctypes.byref(total_bytes), ctypes.byref(free_bytes)
    )
    return total_bytes.value, free_bytes.value

total_before, free_before = get_total_free_space(BASE_PATH)

cutoff_time = datetime.now() - timedelta(days=RETENTION_DAYS)
deleted_space_bytes = 0

# ----- Folder Cleanup (Bottom-Up Walk) -----
for root, dirs, files in os.walk(BASE_PATH, topdown=False):

    # Check folder timestamp directly
    try:
        folder_mtime = datetime.fromtimestamp(os.path.getmtime(root))

        if folder_mtime < cutoff_time:
            # Calculate folder size before deleting
            size_before = sum(os.path.getsize(os.path.join(dp, f))
                              for dp, dn, fn in os.walk(root) for f in fn)
            shutil.rmtree(root, ignore_errors=True)
            deleted_space_bytes += size_before
            logging.info(f"Deleted folder (based on folder timestamp): {root} ({size_before/1024/1024:.2f} MB)")

    except Exception as e:
        logging.error(f"Error processing folder {root}: {e}")

# ----- Disk Space Summary -----
total_after, free_after = get_total_free_space(BASE_PATH)

logging.info(f"Total Space Before: {total_before/1024/1024/1024:.2f} GB")
logging.info(f"Free Space Before: {free_before/1024/1024/1024:.2f} GB")
logging.info(f"Total Space After: {total_after/1024/1024/1024:.2f} GB")
logging.info(f"Free Space After: {free_after/1024/1024/1024:.2f} GB")
logging.info(f"Space Reclaimed: {deleted_space_bytes/1024/1024:.2f} MB")

print(f"âœ… Cleanup Complete. Log saved: {log_filename}")